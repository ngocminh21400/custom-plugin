{"version":3,"sources":["../src/rendering.js"],"names":[],"mappings":";;;;;;;AAOe,WAAS,IAAT,CAAc,KAAd,EAAqB,IAArB,EAA2B,KAA3B,EAAkC,IAAlC,EAAwC;AACrD,QAAI,IAAJ,EAAU,KAAV;AACA,QAAI,YAAY,EAAhB;;AAEA,WAAO,KAAK,IAAL,CAAU,WAAV,CAAP;;AAEA,SAAK,MAAL,CAAY,EAAZ,CAAe,QAAf,EAAyB,YAAW;AAClC;AACA,WAAK,kBAAL;AACD,KAHD;;AAKA,aAAS,MAAT,GAAkB;AAChB,UAAI,CAAC,KAAK,IAAV,EAAgB;AAAE;AAAS;;AAE3B,aAAO,KAAK,IAAZ;AACA,cAAQ,KAAK,KAAb;;AAEA,UAAI,kBAAJ,EAAwB;AACtB;AACD;AACF;;AAED,aAAS,gBAAT,GAA4B;AAC1B,UAAI;AACF,YAAI,SAAS,KAAK,MAAL,IAAe,MAAM,MAArB,IAA+B,KAAK,GAAL,CAAS,MAArD;AACA,YAAI,EAAE,QAAF,CAAW,MAAX,CAAJ,EAAwB;AACtB,mBAAS,SAAS,OAAO,OAAP,CAAe,IAAf,EAAqB,EAArB,CAAT,EAAmC,EAAnC,CAAT;AACD;;AAED,kBAAU,CAAV,C;AACA,kBAAU,MAAM,KAAN,GAAc,EAAd,GAAmB,CAA7B,C;;AAEA,aAAK,GAAL,CAAS,QAAT,EAAmB,SAAS,IAA5B;;AAEA,eAAO,IAAP;AACD,OAZD,CAYE,OAAM,CAAN,EAAS;;AACT,eAAO,KAAP;AACD;AACF;;AAED,aAAS,WAAT,GAAuB;;AAErB,UAAI,KAAK,MAAL,KAAgB,CAAhB,IAAqB,KAAK,CAAL,EAAQ,UAAR,CAAmB,MAAnB,KAA8B,CAAvD,EAA0D;AACxD;AACD;;AAED,UAAI,UAAU,KAAK,CAAL,EAAQ,UAAtB;AACA,YAAM,QAAN,GAAiB,EAAE,IAAF,CAAO,QAAQ,CAAR,CAAP,CAAjB;AACA,UAAI,YAAY,gBAAgB,OAAhB,CAAhB;;AAEA,UAAI,YAAY,GAAG,MAAH,CAAU,SAAV,GACb,QADa,CACJ,UAAS,CAAT,EAAY;AACpB,eAAO,MAAM,OAAN,CAAc,EAAE,MAAhB,IACL,EAAE,MADG,GACM,IADb;AAED,OAJa,EAKb,KALa,CAKP,UAAS,CAAT,EAAY;AACjB,eAAO,EAAE,MAAT;AACD,OAPa,CAAhB;;;AAUA,UAAI,YAAY,KAAK,KAAL,EAAhB;AACA,UAAI,aAAa,KAAK,MAAL,EAAjB;AACA,UAAI,SAAS,EAAE,KAAK,EAAP,EAAW,OAAO,EAAlB,EAAsB,QAAQ,EAA9B,EAAkC,MAAM,EAAxC,EAAb;AACA,UAAI,QAAQ,YAAY,OAAO,IAAnB,GAA0B,OAAO,KAA7C;AACA,UAAI,SAAS,aAAa,OAAO,GAApB,GAA0B,OAAO,MAA9C;AACA,UAAI,SAAS,KAAK,GAAL,CAAS,KAAT,EAAgB,MAAhB,IAA0B,CAAvC;AACA,UAAI,WAAW,CAAf;;;AAGA,UAAI,QAAQ,SAAR,KAAQ,CAAS,CAAT,EAAY;AACtB,YAAI,MAAJ;;AAEA,YAAI,CAAE,EAAE,MAAR,EAAgB;AACd,cAAI,KAAJ;;AAEA,cAAI,UAAU,MAAV,CAAiB,MAAjB,GAA0B,EAA9B,EAAkC;AAChC,oBAAQ,GAAG,KAAH,CAAS,UAAT,EAAR;AACD,WAFD,MAEO;AACL,oBAAQ,GAAG,KAAH,CAAS,UAAT,EAAR;AACD;AACD,mBAAS,MAAM,MAAN,CAAa,GAAG,KAAH,CAAS,CAAT,EAAY,EAAZ,CAAb,CAAT;AACA,YAAE,KAAF,GAAU,aAAV;AAED,SAXD,MAWO,IAAI,EAAE,QAAN,EAAgB;AACrB,cAAI,aAAa,GAAG,GAAH,CAAO,EAAE,KAAT,EAAgB,MAAhB,EAAjB;AACA,cAAI,WAAa,GAAG,GAAH,CAAO,EAAE,KAAT,EAAgB,QAAhB,EAAjB;;AAEA,mBAAS,GAAG,KAAH,CAAS,MAAT,GACN,WADM,CACM,GAAG,cADT,EAEN,KAFM,CAEA,CACL,WAAW,QAAX,EADK,EAEL,SAAS,QAAT,EAFK,CAFA,EAMN,MANM,CAMC,CAAC,CAAD,EAAI,EAAE,QAAF,CAAW,MAAX,GAAoB,CAAxB,CAND,CAAT;AAOD;;AAED,YAAI,EAAE,QAAN,EAAgB;AACd,YAAE,QAAF,CAAW,GAAX,CAAe,UAAS,KAAT,EAAgB,CAAhB,EAAmB;AAChC,mBAAO,EAAE,OAAO,MAAM,KAAf,EAAsB,KAAK,CAA3B,EAAP;AACD,WAFD,EAGC,IAHD,CAGM,UAAS,CAAT,EAAW,CAAX,EAAc;AAClB,mBAAO,EAAE,KAAF,GAAU,EAAE,KAAnB;AACD,WALD,EAMC,OAND,CAMS,UAAS,KAAT,EAAgB,CAAhB,EAAmB;AAC1B,cAAE,QAAF,CAAW,MAAM,GAAjB,EAAsB,KAAtB,GAA8B,OAAO,CAAP,CAA9B;AACD,WARD;AASD;;AAED,eAAO,EAAE,KAAT;AACD,OAxCD;;AA0CA,eAAS,cAAT,CAAwB,CAAxB,EAA2B,QAA3B,EAAqC;AACnC,YAAI,YAAY,EAAE,WAAW,EAAb,EAAiB,MAAM,EAAvB,EAA2B,UAAU,EAArC,EAAhB;AACA,YAAI,aAAa,EAAjB;AACA,YAAI,cAAc,MAAM,YAAxB;AACA,YAAI,aAAa,EAAE,KAAnB;;;AAGA,YAAI,YAAY,aAAa,CAAb,CAAhB;AACA,YAAI,IAAI,CAAR;AACA,YAAI,UAAU,MAAV,GAAmB,CAAvB,EAA0B;AACxB,cAAI,UAAU,QAAV,CAAJ,EAAyB;AACvB,yBAAa,UAAU,QAAV,EAAoB,KAAjC;AACD;;AAED,YAAE,IAAF,CAAO,SAAP,EAAkB,UAAS,IAAT,EAAe;AAC/B,sBAAU,SAAV,CAAoB,IAApB,CACE,YAAY,IAAZ,EAAmB,YAAY,KAAK,KAAlB,GAA2B,UAA3B,GAAwC,IAA1D,CADF;;AAIA,gBAAI,MAAM,YAAV,EAAwB;AACtB,4BAAc,YAAY,OAAZ,CAAoB,OAAO,OAAO,GAAP,CAA3B,EAAwC,KAAK,GAA7C,CAAd;AACD;AACF,WARD;AASD;;;AAGD,kBAAU,IAAV,CAAe,IAAf,CAAoB,YAAY,CAAZ,EAAe,UAAf,CAApB;AACA,YAAI,MAAM,YAAV,EAAwB;AACtB,wBAAc,YAAY,OAAZ,CAAoB,OAAO,OAAO,CAAP,CAA3B,EAAsC,EAAE,GAAxC,CAAd;AACD;;;AAGD,YAAI,EAAE,QAAF,IAAc,EAAE,QAAF,CAAW,MAAX,GAAoB,CAAtC,EAAyC;AACvC,YAAE,IAAF,CAAO,EAAE,QAAT,EAAmB,UAAS,IAAT,EAAe,CAAf,EAAkB;AACnC,sBAAU,QAAV,CAAmB,IAAnB,CAAwB,YAAY,IAAZ,EAAkB,UAAlB,CAAxB;AACD,WAFD;AAGD;;AAED,YAAI,MAAM;AACR,qBAAa,SADL;AAER,uBAAa,WAFL;AAGR,oBAAa,EAAE,GAAG,SAAS,CAAT,CAAL,EAAkB,GAAG,SAAS,CAAT,CAArB;AAHL,SAAV;AAKA,eAAO,GAAP;AACD;;AAED,UAAI,WAAW,SAAX,QAAW,CAAS,CAAT,EAAY,CAC1B,CADD;;AAGA,UAAI,QAAQ,SAAR,KAAQ,CAAS,CAAT,EAAY;AACtB,mBAAW,EAAE,KAAb;;AAEA,YAAI,SAAJ,CAAc,MAAd,EACE,UADF,GAEE,QAFF,CAEW,GAFX,EAGE,SAHF,CAGY,GAHZ,EAGiB,SAAS,CAAT,CAHjB;;AAKA;AACD,OATD;;AAWA,UAAI,YAAY,SAAZ,SAAY,CAAS,CAAT,EAAY;AAC1B,YAAI,WAAW,GAAG,KAAH,CAAS,GAAG,MAAH,CAAU,mBAAmB,KAAK,KAAL,CAAW,EAAxC,EAA4C,IAA5C,EAAT,CAAf;AACA,YAAI,cAAc,eAAe,CAAf,EAAkB,QAAlB,CAAlB;AACA,sBAAc,WAAd;AACD,OAJD;;AAMA,UAAI,IAAI,GAAG,KAAH,CAAS,MAAT,GAAkB,KAAlB,CAAwB,CAAC,CAAD,EAAI,IAAI,KAAK,EAAb,CAAxB,CAAR;AACA,UAAI,IAAI,GAAG,KAAH,CAAS,IAAT,GAAgB,KAAhB,CAAsB,CAAC,CAAD,EAAI,MAAJ,CAAtB,CAAR;;AAEA,UAAI,MAAM,GAAG,GAAH,CAAO,GAAP,GACP,UADO,CACI,UAAS,CAAT,EAAY;AACtB,eAAO,KAAK,GAAL,CAAS,CAAT,EAAY,KAAK,GAAL,CAAS,IAAI,KAAK,EAAlB,EAAsB,EAAE,EAAE,CAAJ,CAAtB,CAAZ,CAAP;AACD,OAHO,EAIP,QAJO,CAIE,UAAS,CAAT,EAAY;AACpB,eAAO,KAAK,GAAL,CAAS,CAAT,EAAY,KAAK,GAAL,CAAS,IAAI,KAAK,EAAlB,EAAsB,EAAE,EAAE,CAAF,GAAM,EAAE,EAAV,CAAtB,CAAZ,CAAP;AACD,OANO,EAOP,WAPO,CAOK,UAAS,CAAT,EAAY;AACvB,eAAO,KAAK,GAAL,CAAS,CAAT,EAAY,EAAE,EAAE,CAAJ,CAAZ,CAAP;AACD,OATO,EAUP,WAVO,CAUK,UAAS,CAAT,EAAY;AACvB,eAAO,KAAK,GAAL,CAAS,CAAT,EAAY,EAAE,EAAE,CAAF,GAAM,EAAE,EAAV,CAAZ,CAAP;AACD,OAZO,CAAV;;AAcA,UAAI,WAAW,SAAX,QAAW,CAAS,CAAT,EAAY;AACzB,YAAI,KAAK,GAAG,WAAH,CAAe,EAAE,MAAF,EAAf,EAA2B,CAAC,EAAE,CAAH,EAAM,EAAE,CAAF,GAAM,EAAE,EAAd,CAA3B,CAAT;AACA,YAAI,KAAK,GAAG,WAAH,CAAe,EAAE,MAAF,EAAf,EAA2B,CAAC,EAAE,CAAH,EAAM,CAAN,CAA3B,CAAT;AACA,YAAI,KAAK,GAAG,WAAH,CAAe,EAAE,KAAF,EAAf,EAA0B,CAAC,EAAE,CAAF,GAAM,EAAN,GAAW,CAAZ,EAAe,MAAf,CAA1B,CAAT;;AAEA,eAAO,UAAS,CAAT,EAAY,CAAZ,EAAe;AACpB,iBAAO,IACL,UAAS,CAAT,EAAY;AACV,mBAAO,IAAI,CAAJ,CAAP;AACD,WAHI,GAIL,UAAS,CAAT,EAAY;AACV,cAAE,MAAF,CAAS,GAAG,CAAH,CAAT;AACA,cAAE,MAAF,CAAS,GAAG,CAAH,CAAT,EAAgB,KAAhB,CAAsB,GAAG,CAAH,CAAtB;AACA,mBAAO,IAAI,CAAJ,CAAP;AACD,WARH;AASD,SAVD;AAWD,OAhBD;;;AAmBA,SAAG,MAAH,CAAU,iBAAiB,KAAK,KAAL,CAAW,EAAtC,EAA0C,MAA1C;;AAEA,UAAI,MAAM,GAAG,MAAH,CAAU,mBAAmB,KAAK,KAAL,CAAW,EAAxC,EACP,IADO,CACF,OADE,EACO,QAAQ,OAAO,IAAf,GAAsB,OAAO,KADpC,EAEP,IAFO,CAEF,QAFE,EAEQ,SAAS,OAAO,GAAhB,GAAsB,OAAO,MAFrC,EAGP,EAHO,CAGJ,OAHI,EAGK,YAAW;AACtB,WAAG,MAAH,CAAU,uBAAuB,KAAK,KAAL,CAAW,EAA5C,EACG,OADH,CACW,QADX,EACqB,IADrB;AAED,OANO,EAOT,MAPS,CAOF,GAPE,EAQP,IARO,CAQF,IARE,EAQI,gBAAgB,KAAK,KAAL,CAAW,EAR/B,EASP,IATO,CASF,WATE,EASW,gBAChB,OAAO,IAAP,GAAc,QAAS,CADP,IACY,IADZ,IAEhB,OAAO,GAAP,GAAc,SAAS,CAFP,IAEY,GAXvB,CAAV;;AAcA,UAAI,OAAO,IAAI,SAAJ,CAAc,MAAd,EACR,IADQ,CACH,UAAU,KAAV,CAAgB,SAAhB,CADG,EAER,KAFQ,GAGV,MAHU,CAGH,MAHG,EAIR,IAJQ,CAIH,GAJG,EAIE,GAJF,EAKR,IALQ,CAKH,QALG,EAKO,MALP,EAMR,IANQ,CAMH,WANG,EAMU,SANV,EAOR,IAPQ,CAOH,MAPG,EAOK,KAPL,EAQR,EARQ,CAQL,OARK,EAQI,KARJ,EASR,EATQ,CASL,WATK,EASQ,SATR,EAUR,EAVQ,CAUL,UAVK,EAUO,QAVP,CAAX;AAWD;;;AAGD,aAAS,eAAT,CAAyB,UAAzB,EAAqC;AACnC,UAAI,OAAO,GAAG,IAAH,EAAX;AACA,QAAE,IAAF,CAAO,MAAM,QAAb,EAAuB,UAAS,GAAT,EAAc,KAAd,EAAqB;;AAE1C,kBAAU,QAAQ,CAAlB,IAAuB,oBAAoB,MAAM,MAAN,CAAa,GAAb,CAApB,CAAvB;;;AAGA,YAAI,UAAU,MAAM,QAAN,CAAe,MAAf,GAAwB,CAAtC,EAAyC;AACvC,iBAAO,KAAK,GAAL,CAAS,UAAS,CAAT,EAAY;AAC1B,mBAAQ,EAAE,GAAF,CAAD,GAAW,EAAE,GAAF,CAAX,GAAoB,eAA3B;AACD,WAFM,CAAP;AAGD,SAJD,MAIO;AACL,iBAAO,KACJ,MADI,CACG,UAAS,CAAT,EAAY;AAClB,mBAAO,EAAE,CAAF,EAAK,GAAL,CAAP;AACD,WAHI,CAAP;AAID;AACF,OAfD;;AAiBA,UAAI,eAAe,KAAK,OAAL,CAAa,UAAb,CAAnB;AACA,UAAI,iBAAiB,qBAAqB,YAArB,CAArB;;AAEA,UAAI,MAAM;AACR,aAAK,MAAM,OADH;AAER,gBAAQ;AAFA,OAAV;;AAKA,aAAO,GAAP;AACD;;AAED,aAAS,oBAAT,CAA8B,IAA9B,EAAoC;AAClC,QAAE,IAAF,CAAO,IAAP,EAAa,UAAS,SAAT,EAAoB,OAApB,EAA6B;AACxC,YAAI,QAAO,SAAP,yCAAO,SAAP,OAAsB,QAA1B,EAAoC;AAClC,cAAI,MAAM,OAAN,CAAc,UAAU,MAAxB,KACA,UAAU,MAAV,CAAiB,CAAjB,EAAoB,GAApB,KAA4B,eADhC,EAEA;AACI,iBAAK,OAAL,EAAc,MAAd,GAAuB,UAAU,MAAV,CAAiB,CAAjB,EAAoB,MAA3C;AACH,WAJD,MAIO;AACH,iBAAK,OAAL,IAAgB,qBAAqB,SAArB,CAAhB;AACH;AACF;AACF,OAVD;;AAYA,aAAO,IAAP;AACD;;AAED,aAAS,mBAAT,CAA6B,KAA7B,EAAoC;AAClC,UAAI,kBAAkB,SAAlB,eAAkB,CAAS,CAAT,EAAY;AAChC,eAAO,CAAP;AACD,OAFD;;AAIA,UAAI,CAAE,KAAN,EAAa;AACX,eAAO,eAAP;AACD;;AAED,cAAQ,MAAM,IAAd;AACA,aAAK,MAAL;AACE,cAAI,eAAe,SAAf,YAAe,CAAS,CAAT,EAAY;AAC7B,gBAAI,WAAW,CAAX,CAAJ;AACA,gBAAI,OAAO,OAAO,CAAP,CAAX;AACA,gBAAI,KAAK,SAAL,CAAe,aAAf,EAAJ,EAAoC;AAClC,qBAAO,KAAK,GAAL,EAAP;AACD;AACD,mBAAO,KAAK,MAAL,CAAY,MAAM,UAAN,IAAoB,qBAAhC,CAAP;AACD,WAPD;AAQA,iBAAO,YAAP;AACA;;AAEF,aAAK,QAAL;AACE,cAAI,iBAAiB,SAAjB,cAAiB,CAAS,CAAT,EAAY;AAC/B,gBAAI,gBAAgB,IAAI,YAAJ,CAAiB,MAAM,IAAvB,CAApB;AACA,gBAAI,WAAW,CAAX,CAAJ;AACA,mBAAO,cAAc,CAAd,EAAiB,MAAM,QAAvB,EAAiC,IAAjC,CAAP;AACD,WAJD;AAKA,iBAAO,cAAP;AACA;;AAEF;AACE,iBAAO,eAAP;AAvBF;AAyBD;;AAED,aAAS,MAAT,CAAgB,KAAhB,EAAuB,KAAvB,EAA8B;AAC5B,UAAI,MAAM,KAAV;;AAEA,UAAI,UAAU,IAAd,EAAoB;AAClB,gBAAQ,UAAU,MAAV,GAAmB,CAA3B;AACD;;AAED,UAAI,UAAU,KAAV,CAAJ,EAAsB;AACpB,YAAI,gBAAgB,UAAU,KAAV,CAApB;AACA,cAAM,cAAc,KAAd,CAAN;AACD;;AAED,aAAO,GAAP;AACD;;AAED,aAAS,YAAT,CAAsB,IAAtB,EAA4B;AAC1B,UAAI,MAAM,EAAV;AACA,UAAI,UAAU,KAAK,MAAnB;AACA,UAAI,CAAE,OAAN,EAAe;AAAE,eAAO,EAAP;AAAY;;AAE7B,aAAO,QAAQ,MAAf,EAAuB;AACrB,YAAI,OAAJ,CAAY,OAAZ;AACA,kBAAU,QAAQ,MAAlB;AACD;AACD,UAAI,OAAJ,CAAY,OAAZ;AACA,aAAO,GAAP;AACD;;AAED,aAAS,YAAT,CAAsB,KAAtB,EAA6B;;AAE3B,UAAI,MAAM,OAAO,KAAK,KAAL,CAAW,QAAQ,KAAnB,IAA4B,GAAnC,CAAV;AACA,UAAI,QAAQ,KAAZ,EAAmB;AACjB,cAAM,QAAN;AACD;AACD,aAAO,GAAP;AACD;;AAED,aAAS,WAAT,CAAqB,IAArB,EAA2B,UAA3B,EAAuC;AACnC,UAAI,MAAO,KAAK,QAAN,GACR,KAAK,KAAL,GAAa,KAAK,QAAL,CAAc,MADnB,GAC4B,KAAK,KAD3C;AAEA,UAAI,OAAQ,eAAe,IAAhB,GACT,OAAO,aAAa,KAAK,KAAL,GAAa,UAA1B,CAAP,IAAgD,GADvC,GAC6C,MADxD;;AAGA,UAAI,OAAO;AACT,aAAO,OAAO,KAAK,GAAZ,EAAiB,KAAK,KAAtB,CADE;AAET,eAAO,OAAO,KAAK,KAAZ,EAAmB,IAAnB,CAFE;AAGT,aAAO,OAAO,GAAP,EAAY,IAAZ,CAHE;AAIT,cAAO,IAJE;AAKT,eAAO,KAAK,KALH;AAMT,eAAO,KAAK;AANH,OAAX;;AASA,aAAO,IAAP;AACH;;AAED,aAAS,aAAT,CAAuB,IAAvB,EAA6B;AAC3B,UAAI,UAAU,GAAG,MAAH,CAAU,uBAAuB,KAAK,KAAL,CAAW,EAA5C,EACX,KADW,CACL,MADK,EACG,KAAK,QAAL,CAAc,CAAd,GAAkB,IADrB,EAEX,KAFW,CAEL,KAFK,EAEG,KAAK,QAAL,CAAc,CAAd,GAAkB,IAFrB,EAGX,OAHW,CAGH,QAHG,EAGO,KAHP,CAAd;;AAKA,cAAQ,SAAR,CAAkB,OAAlB,EAA2B,MAA3B;AACA,cAAQ,SAAR,CAAkB,GAAlB,EAAuB,MAAvB;;AAEA,UAAI,QAAQ,QAAQ,MAAR,CAAe,OAAf,CAAZ;AACA,UAAI,QAAQ,MAAM,MAAN,CAAa,OAAb,CAAZ;AACA,UAAI,QAAQ,MAAM,MAAN,CAAa,OAAb,CAAZ;;AAEA,UAAI,aAAa,CAAE,OAAF,EAAW,KAAX,EAAkB,SAAlB,EAA6B,MAA7B,CAAjB;AACA,YACC,MADD,CACQ,IADR,EAEG,SAFH,CAEa,IAFb,EAGG,IAHH,CAGQ,UAHR,EAGoB,KAHpB,GAIC,MAJD,CAIQ,IAJR,EAKG,IALH,CAKQ,UAAS,CAAT,EAAY;AAAE,eAAO,CAAP;AAAW,OALjC;;AAOA,QAAE,IAAF,CAAO,KAAK,SAAZ,EAAuB,UAAS,IAAT,EAAe,GAAf,EAAoB;AACzC,UAAE,IAAF,CAAO,IAAP,EAAa,UAAS,GAAT,EAAc,CAAd,EAAiB;AAC5B,cAAI,KAAK,MAAM,MAAN,CAAa,IAAb,CAAT;;AAEA,aAAG,MAAH,CAAU,IAAV,EAAgB,IAAhB,CAAqB,OAAO,IAAI,GAAhC,EACG,KADH,CACS;AACL,2BAAgB,QAAQ,MAAR,IAAkB,MAAM,KAAK,MAAL,GAAc,CAAvC,GACA,MADA,GACS,QAFnB;AAGL,4BAAiB,IAAI,KAAJ,GAAY,EAAb,GAAmB,IAH9B;AAIL,2BAAgB,eAAe,IAAI,KAJ9B;AAKL,0BAAc;AALT,WADT;AAQA,aAAG,MAAH,CAAU,IAAV,EAAgB,IAAhB,CAAqB,IAAI,KAAzB;AACA,aAAG,MAAH,CAAU,IAAV,EAAgB,IAAhB,CAAqB,IAAI,GAAzB;AACA,aAAG,MAAH,CAAU,IAAV,EAAgB,IAAhB,CAAqB,IAAI,IAAzB;AACD,SAdD;AAeD,OAhBD;;;AAmBA,UAAI,MAAM,YAAV,EAAwB;AACtB,YAAI,cAAc,KAAK,WAAL,CAAiB,OAAjB,CAAyB,UAAzB,EAAqC,EAArC,CAAlB;;AAEA,gBAAQ,MAAR,CAAe,GAAf,EACG,MADH,CACU,GADV,EAEG,IAFH,CAEQ,MAFR,EAEgB,WAFhB,EAGG,IAHH,CAGQ,QAHR,EAGkB,QAHlB,EAIG,IAJH,CAIQ,UAJR;AAKD;AACF;;AAED,aAAS,WAAT,GAAuB;AACrB,SAAG,MAAH,CAAU,uBAAuB,KAAK,KAAL,CAAW,EAA5C,EACG,OADH,CACW,QADX,EACqB,IADrB;AAED;AACF;;qBAnbuB,I;;;;AANjB,O;;AACA,O;;AACA,Y;;AACA,S;;AACA,Q","file":"rendering.js","sourcesContent":["import './css/sunburst.css!';\nimport _ from 'lodash';\nimport $ from 'jquery';\nimport moment from 'moment';\nimport kbn from 'app/core/utils/kbn';\nimport d3 from './d3.v3.min';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  var data, panel;\n  var formaters = [];\n\n  elem = elem.find('.sunburst');\n\n  ctrl.events.on('render', function() {\n    render();\n    ctrl.renderingCompleted();\n  });\n\n  function render() {\n    if (!ctrl.data) { return; }\n\n    data = ctrl.data;\n    panel = ctrl.panel;\n\n    if (setElementHeight()) {\n      addSunburst();\n    }\n  }\n\n  function setElementHeight() {\n    try {\n      var height = ctrl.height || panel.height || ctrl.row.height;\n      if (_.isString(height)) {\n        height = parseInt(height.replace('px', ''), 10);\n      }\n\n      height -= 5; // padding\n      height -= panel.title ? 24 : 9; // subtract panel title bar\n\n      elem.css('height', height + 'px');\n\n      return true;\n    } catch(e) { // IE throws errors sometimes\n      return false;\n    }\n  }\n\n  function addSunburst() {\n    // Prepare data\n    if (data.length === 0 || data[0].datapoints.length === 0) {\n      return;\n    }\n\n    var rawData = data[0].datapoints;\n    panel.nodeKeys = _.keys(rawData[0]);\n    var hierarchy = createHierarchy(rawData);\n\n    var partition = d3.layout.partition()\n      .children(function(d) {\n        return Array.isArray(d.values) ?\n          d.values : null;\n      })\n      .value(function(d) {\n        return d.values;\n      });\n\n    // Configure graph size\n    var elemWidth = elem.width();\n    var elemHeight = elem.height();\n    var margin = { top: 10, right: 10, bottom: 10, left: 10 };\n    var width = elemWidth - margin.left - margin.right;\n    var height = elemHeight - margin.top - margin.bottom;\n    var radius = Math.min(width, height) / 2;\n    var topDepth = 0;\n\n    // Configure actions\n    var color = function(d) {\n      var colors;\n\n      if (! d.parent) {\n        var scale;\n\n        if (hierarchy.values.length < 10) {\n          scale = d3.scale.category10();\n        } else {\n          scale = d3.scale.category20();\n        }\n        colors = scale.domain(d3.range(0, 10));\n        d.color = 'transparent';\n\n      } else if (d.children) {\n        var startColor = d3.hcl(d.color).darker();\n        var endColor   = d3.hcl(d.color).brighter();\n\n        colors = d3.scale.linear()\n          .interpolate(d3.interpolateHcl)\n          .range([\n            startColor.toString(),\n            endColor.toString()\n          ])\n          .domain([0, d.children.length + 1]);\n      }\n\n      if (d.children) {\n        d.children.map(function(child, i) {\n          return { value: child.value, idx: i};\n        })\n        .sort(function(a,b) {\n          return b.value - a.value\n        })\n        .forEach(function(child, i) {\n          d.children[child.idx].color = colors(i);\n        });\n      }\n\n      return d.color;\n    };\n\n    function prepareTooltip(d, position) {\n      var tableRows = { ancectors: [], node: [], children: [] };\n      var linkParams = [];\n      var tooltipHref = panel.linkTemplate;\n      var totalValue = d.value;\n\n      // d's ancectors\n      var ancectors = getAncestors(d);\n      var i = 0;\n      if (ancectors.length > 0) {\n        if (ancectors[topDepth]) {\n          totalValue = ancectors[topDepth].value;\n        }\n\n        _.each(ancectors, function(node) {\n          tableRows.ancectors.push(\n            tooltipLine(node, (topDepth <= node.depth) ? totalValue : null)\n          );\n\n          if (panel.linkTemplate) {\n            tooltipHref = tooltipHref.replace('\\$' + String(i++), node.key);\n          }\n        });\n      }\n\n      // d itself\n      tableRows.node.push(tooltipLine(d, totalValue));\n      if (panel.linkTemplate) {\n        tooltipHref = tooltipHref.replace('\\$' + String(i), d.key);\n      }\n\n      // d's Children\n      if (d.children && d.children.length > 0) {\n        _.each(d.children, function(node, i) {\n          tableRows.children.push(tooltipLine(node, totalValue));\n        });\n      }\n\n      var rtn = {\n        tableRows:   tableRows,\n        tooltipHref: tooltipHref,\n        position:    { x: position[0], y: position[1] }\n      };\n      return rtn;\n    }\n\n    var mouseout = function(d) {\n    };\n\n    var click = function(d) {\n      topDepth = d.depth;\n\n      svg.selectAll(\"path\")\n       .transition()\n       .duration(750)\n       .attrTween(\"d\", arcTween(d));\n\n      mouseout();\n    };\n\n    var mouseover = function(d) {\n      var position = d3.mouse(d3.select('#sunburst-div-' + ctrl.panel.id).node());\n      var tooltipData = prepareTooltip(d, position);\n      updateTooltip(tooltipData);\n    };\n\n    var x = d3.scale.linear().range([0, 2 * Math.PI]);\n    var y = d3.scale.sqrt().range([0, radius]);\n\n    var arc = d3.svg.arc()\n      .startAngle(function(d) {\n        return Math.max(0, Math.min(2 * Math.PI, x(d.x)));\n      })\n      .endAngle(function(d) {\n        return Math.max(0, Math.min(2 * Math.PI, x(d.x + d.dx)));\n      })\n      .innerRadius(function(d) {\n        return Math.max(0, y(d.y));\n      })\n      .outerRadius(function(d) {\n        return Math.max(0, y(d.y + d.dy));\n      });\n\n    var arcTween = function(d) {\n      var xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]);\n      var yd = d3.interpolate(y.domain(), [d.y, 1]);\n      var yr = d3.interpolate(y.range(), [d.y ? 20 : 0, radius]);\n\n      return function(d, i) {\n        return i ?\n          function(t) {\n            return arc(d);\n          } :\n          function(t) {\n            x.domain(xd(t));\n            y.domain(yd(t)).range(yr(t));\n            return arc(d);\n          };\n      };\n    };\n\n    // Draw graph\n    d3.select(\"#sunburst-g-\" + ctrl.panel.id).remove();\n\n    var svg = d3.select(\"#sunburst-svg-\" + ctrl.panel.id)\n      .attr(\"width\", width + margin.left + margin.right)\n      .attr(\"height\", height + margin.top + margin.bottom)\n      .on(\"click\", function() {\n        d3.select(\"#sunburst-tooltip-\" + ctrl.panel.id)\n          .classed('hidden', true);\n      })\n    .append('g')\n      .attr('id', \"sunburst-g-\" + ctrl.panel.id)\n      .attr(\"transform\", \"translate(\" +\n        (margin.left + width  / 2) + \", \" +\n        (margin.top  + height / 2) + \")\"\n      );\n\n    var path = svg.selectAll(\"path\")\n      .data(partition.nodes(hierarchy))\n      .enter()\n    .append(\"path\")\n      .attr(\"d\", arc)\n      .attr(\"stroke\", \"#fff\")\n      .attr(\"fill-rule\", \"evenodd\")\n      .attr(\"fill\", color)\n      .on(\"click\", click)\n      .on(\"mouseover\", mouseover)\n      .on(\"mouseout\", mouseout);\n  }\n\n  // Functions\n  function createHierarchy(datapoints) {\n    var nest = d3.nest();\n    _.each(panel.nodeKeys, function(key, depth) {\n      // Prepare formaters\n      formaters[depth + 1] = createValueFormater(panel.styles[key]);\n\n      // Prepare nest\n      if (depth !== panel.nodeKeys.length - 1) {\n        nest = nest.key(function(d) {\n          return (d[key]) ? d[key] : '__undefined__';\n        });\n      } else {\n        nest = nest\n          .rollup(function(v) {\n            return v[0][key];\n          });\n      }\n    });\n\n    var nestedValues = nest.entries(datapoints);\n    var filteredValues = removeUndefinedNodes(nestedValues);\n\n    var rtn = {\n      key: panel.rootKey,\n      values: filteredValues\n    };\n\n    return rtn;\n  }\n\n  function removeUndefinedNodes(json) {\n    _.each(json, function(jsonValue, jsonKey) {\n      if (typeof(jsonValue) === \"object\") {\n        if (Array.isArray(jsonValue.values) &&\n            jsonValue.values[0].key === '__undefined__')\n        {\n            json[jsonKey].values = jsonValue.values[0].values;\n        } else {\n            json[jsonKey] = removeUndefinedNodes(jsonValue);\n        }\n      }\n    });\n\n    return json;\n  }\n\n  function createValueFormater(style) {\n    var defaultFormater = function(v) {\n      return v;\n    };\n\n    if (! style) {\n      return defaultFormater;\n    }\n\n    switch (style.type) {\n    case 'date':\n      var dateFormater = function(v) {\n        v = parseFloat(v);\n        var date = moment(v);\n        if (ctrl.dashboard.isTimezoneUtc()) {\n          date = date.utc();\n        }\n        return date.format(style.dateFormat || 'YYYY-MM-DD HH:mm:ss');\n      };\n      return dateFormater;\n      break;\n\n    case 'number':\n      var numberFormater = function(v) {\n        var valueFormater = kbn.valueFormats[style.unit];\n        v = parseFloat(v);\n        return valueFormater(v, style.decimals, null);\n      };\n      return numberFormater;\n      break;\n\n    default:\n      return defaultFormater;\n    }\n  }\n\n  function format(value, depth) {\n    var rtn = value;\n\n    if (depth === null) {\n      depth = formaters.length - 1;\n    }\n\n    if (formaters[depth]) {\n      var valueFormater = formaters[depth];\n      rtn = valueFormater(value);\n    }\n\n    return rtn;\n  }\n\n  function getAncestors(node) {\n    var rtn = [];\n    var current = node.parent;\n    if (! current) { return []; }\n\n    while (current.parent) {\n      rtn.unshift(current);\n      current = current.parent;\n    }\n    rtn.unshift(current);\n    return rtn;\n  }\n\n  function floorPercent(value) {\n    // Format like \"12.34\"\n    var rtn = String(Math.floor(value * 10000) / 100);\n    if (rtn === '100') {\n      rtn = '100.00';\n    }\n    return rtn;\n  }\n\n  function tooltipLine(node, totalValue) {\n      var avg = (node.children) ?\n        node.value / node.children.length : node.value;\n      var rate = (totalValue !== null) ?\n        String(floorPercent(node.value / totalValue)) + '%' : '----';\n\n      var line = {\n        key:   format(node.key, node.depth),\n        value: format(node.value, null),\n        avg:   format(avg, null),\n        rate:  rate,\n        depth: node.depth,\n        color: node.color\n      }\n\n      return line;\n  }\n\n  function updateTooltip(data) {\n    var tooltip = d3.select(\"#sunburst-tooltip-\" + ctrl.panel.id)\n      .style(\"left\", data.position.x + \"px\")\n      .style(\"top\",  data.position.y + \"px\")\n      .classed(\"hidden\", false);\n\n    tooltip.selectAll('table').remove();\n    tooltip.selectAll('p').remove();\n\n    var table = tooltip.append('table');\n    var thead = table.append('thead');\n    var tbody = table.append('tbody');\n\n    var headerCols = [ 'field', 'sum', 'average', 'rate' ];\n    thead\n    .append('tr')\n      .selectAll('td')\n      .data(headerCols).enter()\n    .append('td')\n      .text(function(d) { return d; });\n\n    _.each(data.tableRows, function(rows, key) {\n      _.each(rows, function(row, i) {\n        var tr = tbody.append('tr');\n\n        tr.append('td').text('- ' + row.key)\n          .style({\n            'font-weight': (key === 'node' && i === rows.length - 1) ?\n                           'bold' : 'normal',\n            'padding-left': (row.depth * 10) + 'px',\n            'border-left' : '3px solid ' + row.color,\n            'text-align': 'left'\n          });\n        tr.append('td').text(row.value);\n        tr.append('td').text(row.avg);\n        tr.append('td').text(row.rate);\n      });\n    });\n\n    // Link\n    if (panel.linkTemplate) {\n      var tooltipHref = data.tooltipHref.replace(/\\/\\$\\d*/g, '');\n\n      tooltip.append('p')\n        .append('a')\n        .attr('href', tooltipHref)\n        .attr('target', '_blank')\n        .text('[ link ]');\n    }\n  }\n\n  function hideTooltip() {\n    d3.select(\"#sunburst-tooltip-\" + ctrl.panel.id)\n      .classed('hidden', true);\n  }\n}\n\n"]}